<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TFM — Telegram Football Manager (WebApp)</title>

<!-- Telegram WebApp script -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#07102a; --card:#0f2340; --accent:#ffd166; --muted:#92a0b8;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,Arial,Helvetica,sans-serif;
    background: linear-gradient(180deg, #041028 0%, #07233a 100%);
    color:#e6eef8; min-height:100vh; display:flex; flex-direction:column; align-items:center;
  }

  header{width:100%; max-width:980px; padding:18px; display:flex; align-items:center; gap:12px;}
  .logo{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#2b6bff,#7b2bff); display:flex; align-items:center; justify-content:center; font-weight:700; color:white;}
  h1{font-size:18px; margin:0;}
  .subtitle{color:var(--muted); font-size:12px;}

  main{width:100%; max-width:980px; padding:12px; display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start;}
  /* left column: field + tactics */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; box-shadow: 0 6px 20px rgba(2,8,23,0.6);
  }

  /* Field */
  .field{
    background: linear-gradient(180deg,#0b4b17,#093e14);
    border-radius:10px; padding:8px; height:400px; position:relative; overflow:hidden;
  }
  .field-grid{position:absolute; inset:10px; border-radius:8px; display:grid; grid-template-rows: repeat(6,1fr)}
  .player-slot{
    border-radius:50%; width:56px; height:56px; background:rgba(255,255,255,0.06);
    display:flex; align-items:center; justify-content:center; color:white; font-size:12px;
    transition: transform .14s ease, box-shadow .14s ease;
    cursor:grab;
  }
  .player-slot.dragging{transform:scale(1.06); box-shadow: 0 8px 24px rgba(0,0,0,0.6)}
  .field-topline{position:absolute; left:50%; transform:translateX(-50%); top:8px; color:rgba(255,255,255,0.08); font-size:11px;}

  /* right column: roster */
  .roster{ display:flex; flex-direction:column; gap:10px; }
  .card{ background:var(--card); border-radius:10px; padding:10px; display:flex; gap:10px; align-items:center;}
  .avatar{width:56px; height:56px; border-radius:10px; background:linear-gradient(135deg,#2b6bff,#7b2bff); display:flex; align-items:center; justify-content:center; font-weight:700;}
  .meta{flex:1;}
  .name{font-weight:700}
  .pos{font-size:12px; color:var(--muted)}
  .small{font-size:12px; color:var(--muted)}

  /* controls */
  .controls{display:flex; gap:8px; margin-top:12px;}
  button{
    border:0; background:var(--accent); color:#081426; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer;
  }
  .ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04);}

  /* tactics */
  .tactics{display:flex; gap:8px; margin-top:10px}
  .tactics button{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; cursor:pointer}
  .tactics button.active{background:rgba(255,255,255,0.04); color:white; border-color:rgba(255,255,255,0.08)}

  /* animations */
  .pulse{animation: pulse 1.6s infinite ease-in-out}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

  footer{width:100%; max-width:980px; padding:12px; color:var(--muted); font-size:12px; text-align:center;}
</style>
</head>
<body>

<header>
  <div class="logo">TF</div>
  <div>
    <h1>Telegram Football Manager</h1>
    <div class="subtitle" id="coachName">Привет, тренер</div>
  </div>
</header>

<main>
  <!-- LEFT: field & tactics -->
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <strong id="clubName">FC Demo</strong><div class="small" id="clubFans">Фанаты: —</div>
      </div>
      <div style="text-align:right">
        <div class="small">Рейтинг команды</div>
        <div id="teamRating" style="font-weight:800; font-size:18px">—</div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <div class="tactics" id="tacticsBtns">
        <button class="active" data-form="4-4-2">4-4-2</button>
        <button data-form="4-3-3">4-3-3</button>
        <button data-form="3-5-2">3-5-2</button>
      </div>
      <div style="flex:1"></div>
      <div class="small">Формация и тактика</div>
    </div>

    <div style="margin-top:12px; position:relative;">
      <div class="field">
        <div class="field-topline">Поле — перетащи игроков на позицию</div>
        <div id="fieldGrid" class="field-grid"></div>
      </div>
    </div>

    <div class="controls">
      <button id="playBtn">▶ Играть матч</button>
      <button class="ghost" id="autoBtn">Автоподбор состава</button>
      <button class="ghost" id="saveBtn">Сохранить в боте</button>
    </div>

    <div id="logArea" style="margin-top:12px; color:var(--muted); font-size:13px; min-height:48px"></div>
  </div>

  <!-- RIGHT: roster -->
  <aside class="roster">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div><strong>Состав клуба</strong></div>
      <div class="small">Перетащи на поле</div>
    </div>

    <div id="rosterList" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
      <!-- cards генерируются JS -->
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <button class="ghost" id="refreshBtn">Загрузить с бота</button>
      <button class="ghost" id="demoBtn">Демо-данные</button>
    </div>
  </aside>
</main>

<footer>
  Веб-версия прототипа — данные загружаются через API бота / сервера. Нажми «Загрузить с бота» или «Демо-данные».
</footer>

<script>
/* ============ Telegram WebApp init ============ */
const tg = window.Telegram.WebApp;
tg.expand(); // разворачиваем WebApp, если возможно
const initData = tg.initData || null;
const initDataUnsafe = tg.initDataUnsafe || {};
const user = initDataUnsafe.user || null;
if(user){
  document.getElementById('coachName').innerText = `Привет, ${user.first_name}`;
}

/* ============ конфигурация ============ */
// сюда ставим URL твоего backend API, который отдаёт /api/club?user_id=...
// если нет сервера — оставляем пустым, WebApp использует демо-данные
const BACKEND_API = "https://your-server.example.com"; // <--- поменяй на свой backend
const queryParams = new URLSearchParams(location.search);
const urlUserId = queryParams.get("user_id") || (user ? user.id : null);

/* ============ состояние клиента ============ */
let club = null;
let formation = "4-4-2";

/* ---------- утилиты ---------- */
function rnd(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function human(n){ return Math.round(n*10)/10; }

/* ============ DEMO data generator (если сервер не настроен) ============ */
function demoClub(){
  const demo = {
    name: "FC Demo",
    fans: 1200 + rnd(0,2000),
    players: []
  };
  const posPool = ["GK","DEF","MID","FWD"];
  // создаём 16 игроков
  for(let i=0;i<16;i++){
    const pos = i===0 ? "GK" : (i<5 ? "DEF" : (i<11 ? "MID" : "FWD"));
    const p = {
      id: "p"+(1000+i),
      name: ["Алекс","Иван","Марк","Олег","Роман","Сергей","Михаил","Даниил"][rnd(0,7)] + " " + ["Иванов","Петров","Сидоров","Кузнецов"][rnd(0,3)],
      position: pos,
      strength: rnd(45,90),
      speed: rnd(45,90),
      agility: rnd(45,90),
      talent: rnd(45,90),
      both_feet: Math.random() < 0.25,
      fitness: rnd(80,100),
      morale: rnd(40,80),
    };
    p.rating = Math.round((p.strength*0.2 + p.speed*0.25 + p.agility*0.2 + p.talent*0.35 + (p.both_feet?3:0))*(0.6 + 0.4*(p.fitness/100))*(0.9 + 0.2*(p.morale/100))*10)/10;
    demo.players.push(p);
  }
  return demo;
}

/* ============ Загрузка данных с backend ============ */
async function loadClubFromServer(){
  if(!BACKEND_API || !urlUserId){
    return null;
  }
  try{
    const resp = await fetch(`${BACKEND_API.replace(/\/$/,"")}/api/club?user_id=${urlUserId}`);
    if(!resp.ok) throw new Error("server error");
    const json = await resp.json();
    return json;
  }catch(e){
    console.warn("Failed to load from server:", e);
    return null;
  }
}

/* ============ UI render ============ */
function renderRoster(){
  const container = document.getElementById('rosterList');
  container.innerHTML = "";
  (club.players || []).forEach(p=>{
    const card = document.createElement('div');
    card.className = "card";
    card.draggable = true;
    card.dataset.pid = p.id;
    card.innerHTML = `<div class="avatar">${p.name.split(" ")[0][0]||"P"}</div>
      <div class="meta">
        <div class="name">${p.name}</div>
        <div class="pos">${p.position} • рейтинг ${p.rating}</div>
        <div class="small">Форма ${p.fitness}% • Мораль ${p.morale}</div>
      </div>`;
    // drag events
    card.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', p.id);
      setTimeout(()=>card.classList.add('dragging'),10);
    });
    card.addEventListener('dragend', ()=>card.classList.remove('dragging'));
    container.appendChild(card);
  });
}

/* Field slots generation (simple grid that visually places 11 slots) */
function buildFieldSlots(){
  const grid = document.getElementById('fieldGrid');
  grid.innerHTML = "";
  // make 6 rows; we will place visual slots in some rows to resemble formation
  for(let r=0;r<6;r++){
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '6px';
    // each row has variable number of slots
    const cols = 7;
    for(let c=0;c<cols;c++){
      const slot = document.createElement('div');
      slot.className = 'player-slot';
      slot.dataset.slot = `${r}-${c}`;
      slot.style.opacity = 0.0; // we'll activate needed slots by formation
      slot.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      slot.addEventListener('drop', (e)=>{
        e.preventDefault();
        const pid = e.dataTransfer.getData('text/plain');
        placePlayerToSlot(pid, slot);
      });
      row.appendChild(slot);
    }
    grid.appendChild(row);
  }
}

/* Map formation to visible slot positions (row,col pairs) */
const FORMATION_SLOTS = {
  "4-4-2": [[5,3],[3,1],[3,2],[3,3],[3,4],[2,2],[2,4],[1,2],[1,4],[0,2],[0,4]],
  "4-3-3": [[5,3],[3,1],[3,2],[3,3],[3,4],[2,3],[2,2],[2,4],[1,1],[1,3],[1,5]],
  "3-5-2": [[5,3],[3,1],[3,3],[3,5],[2,1],[2,2],[2,3],[2,4],[2,5],[1,2],[1,4]]
};

function highlightFormation(form){
  formation = form;
  // set active button
  document.querySelectorAll('#tacticsBtns button').forEach(b=>b.classList.toggle('active', b.dataset.form===form));
  // clear all slots, show needed ones
  const slots = document.querySelectorAll('.player-slot');
  slots.forEach(s=>{ s.innerText=""; s.dataset.playerId = ""; s.style.opacity = 0.0; });
  const coords = FORMATION_SLOTS[form] || FORMATION_SLOTS["4-4-2"];
  coords.forEach((pair, idx)=>{
    const row = pair[0], col = pair[1];
    const slot = document.querySelector(`.player-slot[data-slot='${row}-${col}']`);
    if(slot){
      slot.style.opacity = 1.0;
      slot.dataset.slotIndex = idx;
      slot.innerText = (idx===0? "GK": `#${idx}`);
    }
  });
}

/* place player by id into slot DOM element */
function placePlayerToSlot(pid, slotEl){
  const p = club.players.find(x=>x.id===pid);
  if(!p) return;
  // if player already on field, remove from previous
  document.querySelectorAll('.player-slot').forEach(s=>{
    if(s.dataset.playerId===pid) { s.dataset.playerId=""; s.innerText = s.dataset.slotIndex? s.dataset.slotIndex: ""; }
  });
  slotEl.dataset.playerId = pid;
  slotEl.innerHTML = `<div style="text-align:center">${p.name.split(" ")[0]}<div style="font-size:11px;color:#cfe6ff">${p.position}</div></div>`;
}

/* autoselect best 11 */
function autoPick(){
  const sorted = club.players.slice().sort((a,b)=>b.rating - a.rating);
  const pick = sorted.slice(0,11);
  // clear slots
  document.querySelectorAll('.player-slot').forEach(s=> { s.dataset.playerId=""; s.innerText = s.dataset.slotIndex? s.dataset.slotIndex:""; });
  const coords = FORMATION_SLOTS[formation] || FORMATION_SLOTS["4-4-2"];
  for(let i=0;i<11;i++){
    const pair = coords[i];
    const slot = document.querySelector(`.player-slot[data-slot='${pair[0]}-${pair[1]}']`);
    if(slot) placePlayerToSlot(pick[i].id, slot);
  }
  log("Автоподбор выполнен");
}

/* read starters from field DOM */
function readStartersFromField(){
  const slots = Array.from(document.querySelectorAll('.player-slot')).filter(s=>s.style.opacity>0 && s.dataset.playerId);
  const starters = slots.map(s=> club.players.find(p=>p.id===s.dataset.playerId)).filter(Boolean);
  return starters;
}

/* compute simple team strength */
function computeTeamRating(starters){
  if(!starters || starters.length===0) return 0;
  const sum = starters.reduce((acc,p)=> acc + p.rating * (p.fitness/100), 0);
  return Math.round(sum*10)/10;
}

/* play simulation locally and send result to bot */
async function playMatch(){
  const starters = readStartersFromField();
  if(starters.length<11){
    alert("Нужно выставить 11 игроков на поле (перетащи с правой панели).");
    return;
  }
  const rating = computeTeamRating(starters);
  document.getElementById('teamRating').innerText = rating;
  log("Начинаем симуляцию...");
  // simple xG model
  const oppAvg = rating + (Math.random()*20 - 10);
  const teamXg = Math.max(0.2, 1.0 + (rating - oppAvg)/200 + (Math.random()-0.5)*0.8);
  const oppXg = Math.max(0.2, 1.0 + (oppAvg - rating)/200 + (Math.random()-0.5)*0.8);

  const teamGoals = poissonGoals(teamXg);
  const oppGoals = poissonGoals(oppXg);

  // animate timeline messages
  await animateMatchTimeline(teamGoals, oppGoals);

  // send result to bot
  const result = {
    action: "match_result",
    payload: {
      club_name: club.name,
      user_id: urlUserId,
      team_rating: rating,
      team_goals: teamGoals,
      opp_goals: oppGoals,
      starters: starters.map(s=>({id:s.id, name:s.name, position:s.position, rating:s.rating}))
    }
  };

  try{
    tg.sendData(JSON.stringify(result));
    log("Результат отправлен боту ✅");
  }catch(e){
    console.warn("sendData failed", e);
    log("Не удалось отправить результат боту (sendData).");
  }
}

/* poisson-like goal generator */
function poissonGoals(xg){
  // xg ~ expected goals; draw from simple Poisson using thinning
  let goals = 0;
  let prob = Math.min(0.9, Math.max(0.05, xg / 2.5));
  while(Math.random() < prob){
    goals++;
    prob *= 0.45;
  }
  return goals;
}

/* timeline animation */
async function animateMatchTimeline(tgGoals, ogGoals){
  const logArea = document.getElementById('logArea');
  logArea.innerHTML = "";
  const events = [];
  for(let i=0;i<tgGoals;i++) events.push({minute: rnd(1,90), team:"you"});
  for(let i=0;i<ogGoals;i++) events.push({minute: rnd(1,90), team:"opp"});
  events.sort((a,b)=>a.minute - b.minute);

  logArea.innerText = "⚽ Матч начался...";
  await sleep(900);
  for(const e of events){
    logArea.innerText = `${e.minute}' — ${e.team==="you" ? "ГОООЛ! Твой клуб" : "Гол соперника"}`;
    await sleep(900 + Math.random()*600);
  }
  await sleep(700);
  logArea.innerText = `🏁 Финал: Твой клуб ${tgGoals} : ${ogGoals} Соперник`;
}

/* helpers */
function log(txt){ document.getElementById('logArea').innerText = txt; }
function sleep(ms){ return new Promise(res=>setTimeout(res,ms)); }

/* ============ Events binding ============ */
document.getElementById('demoBtn').addEventListener('click', ()=>{
  club = demoClub();
  document.getElementById('clubName').innerText = club.name;
  document.getElementById('clubFans').innerText = `Фанаты: ${club.fans}`;
  renderRoster();
  highlightFormation(formation);
});

document.getElementById('refreshBtn').addEventListener('click', async ()=>{
  const remote = await loadClubFromServer();
  if(remote){
    club = remote;
    document.getElementById('clubName').innerText = club.name;
    document.getElementById('clubFans').innerText = `Фанаты: ${club.fans}`;
    renderRoster();
    highlightFormation(formation);
    log("Данные загружены с сервера.");
  }else{
    log("Сервер не ответил — используем демо-данные.");
    club = demoClub();
    document.getElementById('clubName').innerText = club.name;
    document.getElementById('clubFans').innerText = `Фанаты: ${club.fans}`;
    renderRoster();
    highlightFormation(formation);
  }
});

document.getElementById('autoBtn').addEventListener('click', ()=> autoPick());
document.getElementById('playBtn').addEventListener('click', ()=> playMatch());
document.getElementById('saveBtn').addEventListener('click', ()=>{
  // In full implementation, we would POST lineup to backend (save formation)
  tg.sendData(JSON.stringify({action:"save_lineup", payload:{formation, starters: readStartersFromField().map(p=>p? p.id: null)}}));
  log("Сохранение отправлено боту...");
});

document.querySelectorAll('#tacticsBtns button').forEach(b=>{
  b.addEventListener('click', ()=> highlightFormation(b.dataset.form));
});

/* initialize UI */
buildFieldSlots();
highlightFormation(formation);
document.getElementById('demoBtn').click(); // автозапуск демо

</script>
</body>
</html>
